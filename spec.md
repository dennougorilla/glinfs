# アプリケーション仕様書 - Screen Capture & GIF Generator

**作成日**: 2025-10-31  
**目的**: フレームワークに依存しない純粋な機能仕様  
**備考**: 技術的実装の詳細は plan.md を参照

---

## 1. プロダクト概要

### 1.1 プロダクトビジョン

ブラウザベースの画面録画＆GIFアニメーション作成ツール。

**コアバリュー**:
- 「録画ボタンを押し忘れても大丈夫」- 常時バッファリングによる遡及的なキャプチャ
- 「シンプルだけど強力」- 直感的なUIと高度な編集機能の両立
- 「軽快な動作」- 低メモリ消費と高速な処理

**ターゲットユーザー**:
- チュートリアル作成者
- バグレポート作成者
- ゲーム実況者
- デザイナー（UIアニメーションの記録）
- 開発者（デモGIF作成）

---

## 2. 機能要件

### 2.1 画面キャプチャ機能

#### 2.1.1 基本キャプチャ

**要件**:
- ユーザーは画面全体、特定のウィンドウ、またはタブを選択して録画できる
- 録画は循環バッファ方式で常時実行される（最大10秒分）
- 古いフレームは自動的に破棄される
- ユーザーの明示的な操作なしに自動で録画を開始してはならない（ブラウザセキュリティ要件）

**制約**:
- ブラウザのセキュリティポリシーにより、HTTPS環境が必須
- 録画開始にはユーザーのクリック操作が必要

#### 2.1.2 録画設定

**フレームレート**:
- 範囲: 15, 30, 60 FPS
- デフォルト: 30 FPS
- 高フレームレート = 滑らかな動き、大きなメモリ消費
- 低フレームレート = カクカクした動き、小さなメモリ消費

**バッファサイズ**:
- 範囲: 100-1000 フレーム
- デフォルト: 500 フレーム（30 FPSで約16秒）
- 調整可能: ユーザーのメモリ状況に応じて増減

**サムネイル品質**:
- 範囲: 10%-100%
- デフォルト: 50%
- プレビュー生成時の画質とメモリ使用量のトレードオフ

#### 2.1.3 録画状態表示

ユーザーは以下の情報をリアルタイムで確認できる:
- 録画状態（録画中 / 待機中）
- 現在のフレーム数 / 最大フレーム数
- バッファの時間（秒）
- メモリ使用量（MB）
- 推定最大録画時間

#### 2.1.4 クリップ作成

**トリガー**:
- ユーザーが「Clip」ボタンをクリック
- 現在のバッファ全体を編集用にコピー

**処理**:
- バッファ内のフレームをサムネイル形式で変換
- プログレス表示（例: 50/300 frames processed）
- 完了後、自動的に編集画面に遷移

---

### 2.2 編集機能

#### 2.2.1 フレーム選択

**タイムラインビュー**:
- 横長のタイムラインに全フレームのサムネイルを表示
- セグメント化（画面幅に応じて6-12セグメント）
- ドラッグ可能なハンドルで開始/終了フレームを選択

**操作**:
- 開始ハンドルをドラッグ → 開始フレームを設定
- 終了ハンドルをドラッグ → 終了フレームを設定
- サムネイルをクリック → そのフレームにジャンプ
- 再生ボタン → 選択範囲をプレビュー再生

**表示情報**:
- START: 開始フレーム番号
- END: 終了フレーム番号
- FRAMES: 選択フレーム数
- DURATION: 選択範囲の再生時間（秒）
- TOTAL: 全フレーム数

#### 2.2.2 フレームナビゲーション

**コントロール**:
- 再生/一時停止ボタン
- 前のフレーム / 次のフレーム ボタン
- 最初のフレーム / 最後のフレーム ボタン
- 再生速度調整（0.25x, 0.5x, 1.0x, 1.5x, 2.0x, 3.0x, 4.0x）

**キーボードショートカット**:
- `Space`: 再生/一時停止
- `←` / `→`: 前/次のフレーム
- `Home` / `End`: 最初/最後のフレーム

#### 2.2.3 クロップ機能

**クロップエリア作成**:
- キャンバス上でドラッグ → 新しいクロップエリアを作成
- ダブルクリック → クロップをリセット（全画面表示）

**クロップエリア調整**:
- 8つのリサイズハンドル（四隅 + 各辺の中央）
- ハンドルをドラッグ → サイズ変更
- エリア内をドラッグ → 移動
- エリア外をクリック → 選択解除

**アスペクト比固定**:
- Free（自由）: 制限なし
- 1:1（正方形）: Instagram投稿向け
- 16:9（横長）: YouTube向け
- 4:3（標準）: 古い動画形式
- 9:16（縦長）: TikTok/Instagram Stories向け
- 3:4（縦長標準）

**視覚補助**:
- グリッド表示（3×3, 6×6, 9×9 分割）
- クロップラインの色変更（赤, 青, 黄, 白, ネオン）
- 半透明のマスク（クロップ外を暗く表示）

#### 2.2.4 プレビュー機能

**メインキャンバス**:
- 現在のフレームを中央に大きく表示
- クロップエリアをリアルタイムで反映
- ズームイン/アウト（0.1x - 2.0x）
- パン（ドラッグで移動）

**サムネイルストリップ**:
- 右側に縦並びのサムネイル
- 現在のフレームをハイライト
- クリックでフレームジャンプ

**ステータス表示**:
- 現在のフレーム番号
- フレームの解像度（例: 1920x1080）
- クロップ後の解像度（例: 800x450）
- アスペクト比（例: 16:9）

---

### 2.3 GIFエクスポート機能

#### 2.3.1 エンコーダー選択

**エンコーダーの種類**:
- 高速エンコーダー（5-12秒）: WASMベース、高品質
- 中速エンコーダー（15-25秒）: JavaScriptベース、バランス
- 低速エンコーダー（30秒以上）: フォールバック

**表示情報**:
- エンコーダー名
- 速度ティア（Fast / Medium / Slow）
- 品質ティア（High / Medium / Low）
- ライセンス種別（MIT / GPL）
- 利用可否（ブラウザ対応状況）

**ライセンス制約**:
- 開発ビルド: すべてのエンコーダーが利用可能
- プロダクションビルド: MIT ライセンスのみ利用可能

#### 2.3.2 GIF設定

**品質設定**:
- 範囲: 10%-100%
- デフォルト: 80%
- 説明:
  - 90-100%: 高品質（大きなファイルサイズ）
  - 50-89%: 中品質（バランス）
  - 10-49%: 低品質（小さなファイルサイズ）

**フレームスキップ**:
- 範囲: 1x-5x
- デフォルト: 1x（全フレーム使用）
- 説明:
  - 1x: すべてのフレームを使用
  - 2x: 1フレームおきにスキップ（50%削減）
  - 3x: 2フレームおきにスキップ（66%削減）
  - 5x: 4フレームおきにスキップ（80%削減）

**再生速度**:
- 範囲: 0.25x-2.0x
- デフォルト: 1.0x（通常速度）
- 説明:
  - 0.25-0.5x: スローモーション
  - 0.75-1.25x: 通常速度
  - 1.5-2.0x: 早送り

**ディザリング**:
- ON: 色のグラデーションが滑らか、ファイルサイズ増加
- OFF: 色の段階が目立つ、ファイルサイズ減少

**ループ設定**:
- 0: 無限ループ（推奨）
- 1-9+: 指定回数ループ

**その他オプション**:
- エクスポート後に新しいタブで開く（ON/OFF）

#### 2.3.3 エクスポート処理

**プログレス表示**:
- プログレスバー（0-100%）
- 現在のフレーム / 総フレーム数
- 経過時間
- 推定残り時間
- ステータスメッセージ（準備中 / エンコード中 / 完了 / エラー）

**完了時の動作**:
- 自動ダウンロード、または
- 新しいタブで開く（設定による）
- ダイアログを自動的に閉じる

**エラーハンドリング**:
- エンコードエラー → エラーメッセージ表示、リトライ可能
- ブラウザクラッシュ → 次回起動時にリカバリー提案（オプション）
- メモリ不足 → 品質を自動的に下げて再試行

#### 2.3.4 ファイルサイズ推定

**表示**:
- エクスポート前に推定ファイルサイズを表示（例: 約 2.5 MB）
- 設定変更時にリアルタイムで更新

**計算要素**:
- フレーム数
- 解像度（クロップ後）
- 品質設定
- ディザリング有無

---

## 3. 非機能要件

### 3.1 パフォーマンス

**UI応答性**:
- すべてのUI操作は60 FPS以上を維持
- 重い処理（エンコード、サムネイル生成）はバックグラウンドで実行
- UIスレッドをブロックしない

**メモリ効率**:
- 最大メモリ使用量: 2GB（ブラウザ制限）
- フレームキャッシュ: 現在のフレーム ± 3フレームのみメモリに保持
- 最大キャッシュ: 10フレーム
- 不要なフレームは即座に解放

**処理速度**:
- クリップ作成: 10秒以内（300フレーム）
- GIFエクスポート:
  - 高速エンコーダー: 5-12秒
  - 中速エンコーダー: 15-25秒
  - 低速エンコーダー: 30秒以上

### 3.2 ユーザビリティ

**直感性**:
- 初回ユーザーがガイドなしで基本操作を実行できる
- ツールチップとヘルプダイアログで機能説明

**フィードバック**:
- すべての操作に視覚的フィードバック（ボタンのハイライト、プログレス表示）
- エラーメッセージは具体的で解決策を提示

**レスポンシブデザイン**:
- デスクトップ最適化（1920x1080以上推奨）
- タブレット対応（iPad Pro 12.9インチ以上）
- モバイルは非対応（画面キャプチャAPIの制約）

### 3.3 互換性

**ブラウザサポート**:
- Chrome 94+（推奨）
- Firefox 96+
- Safari 15.4+
- Edge 94+

**OS対応**:
- Windows 10/11
- macOS 11+
- Linux（主要ディストリビューション）

**必須機能**:
- Screen Capture API
- Canvas API
- Web Workers
- WebAssembly（高速エンコーダー使用時）

### 3.4 セキュリティ

**プライバシー**:
- すべての処理はクライアント側で完結
- サーバーへのデータ送信なし
- セッション終了時にバッファをクリア

**セキュアコンテキスト**:
- HTTPS必須（Screen Capture API要件）
- CSP（Content Security Policy）準拠

---

## 4. ユーザーフロー

### 4.1 基本フロー（初回ユーザー）

```
1. アプリケーションにアクセス
   ↓
2. 「Start Screen Sharing」ボタンをクリック
   ↓
3. ブラウザの画面選択ダイアログが表示される
   ↓
4. 共有する画面/ウィンドウ/タブを選択
   ↓
5. 録画が開始される（自動的にバッファリング）
   - ステータス: "Always Recording"
   - バッファ情報: "150/500 frames (5.0s / 16.7s)"
   ↓
6. 必要な操作を実行（デモ、バグ再現など）
   ↓
7. 「Clip」ボタンをクリック
   ↓
8. サムネイル生成（プログレス表示）
   ↓
9. 編集画面に遷移
   ↓
10. フレーム範囲を選択
    - タイムラインのハンドルをドラッグ
    - または個別フレームをクリック
   ↓
11. （オプション）クロップエリアを設定
    - キャンバス上でドラッグ
    - アスペクト比を選択
    - リサイズハンドルで調整
   ↓
12. （オプション）プレビュー再生で確認
    - 再生速度を調整
    - フレーム単位で確認
   ↓
13. 「Export」ボタンをクリック
   ↓
14. エクスポートダイアログで設定
    - エンコーダーを選択
    - 品質、フレームスキップを調整
    - 再生速度、ディザリング、ループを設定
   ↓
15. 「Export」をクリック
   ↓
16. エンコード処理（プログレス表示）
   ↓
17. GIFファイルがダウンロード/新しいタブで開く
   ↓
18. 完了
```

### 4.2 上級ユーザーフロー

**シナリオ: 複数のクリップを連続作成**

```
1. 録画開始
   ↓
2. 最初のアクションを実行
   ↓
3. 「Clip」→ 編集 → エクスポート
   ↓
4. ブラウザバックで録画画面に戻る
   ↓
5. 次のアクションを実行
   ↓
6. 「Clip」→ 編集 → エクスポート
   ↓
7. 繰り返し
```

**シナリオ: 高品質GIF作成（ファイルサイズ制約なし）**

```
1-12. 基本フロー同様
   ↓
13. エクスポートダイアログで設定
    - エンコーダー: 高速（WASM）を選択
    - 品質: 100%
    - フレームスキップ: 1x（全フレーム）
    - ディザリング: ON
    - 解像度: オリジナル
   ↓
14. エクスポート
   ↓
15. 推定サイズ: 約 15 MB
   ↓
16. エンコード完了（約10秒）
   ↓
17. ダウンロード
```

**シナリオ: 軽量GIF作成（SNS投稿向け）**

```
1-12. 基本フロー同様
   ↓
13. エクスポートダイアログで設定
    - エンコーダー: 中速（JavaScript）を選択
    - 品質: 60%
    - フレームスキップ: 2x（50%削減）
    - 再生速度: 1.5x（早送り）
    - ディザリング: OFF
    - 解像度: 最大幅 800px
   ↓
14. エクスポート
   ↓
15. 推定サイズ: 約 1.2 MB
   ↓
16. エンコード完了（約20秒）
   ↓
17. Twitter/Discordに投稿
```

---

## 5. エッジケースとエラーハンドリング

### 5.1 キャプチャフェーズ

| 状況 | ユーザーへの通知 | システムの動作 |
|------|-----------------|--------------|
| 画面共有の許可が拒否された | 「画面共有が許可されませんでした」 | 録画開始しない、再試行ボタン表示 |
| 画面共有が途中で停止された | 「画面共有が停止されました」 | バッファを保持、「Clip」ボタンは有効 |
| メモリ不足 | 「メモリ使用量が上限に近づいています」 | バッファサイズを自動縮小、警告表示 |
| バッファが空（フレーム0） | 「まだフレームがありません」 | 「Clip」ボタンを無効化 |

### 5.2 編集フェーズ

| 状況 | ユーザーへの通知 | システムの動作 |
|------|-----------------|--------------|
| サムネイル生成エラー | 「一部のフレームを読み込めませんでした」 | エラーフレームをスキップして続行 |
| クロップエリアが画面外 | （自動修正、通知なし） | クロップエリアを境界内にクランプ |
| フレーム範囲が空（start == end） | 「少なくとも1フレーム選択してください」 | エクスポートボタンを無効化 |
| Canvas要素が無効 | 「フレームを表示できません」 | 代替画像またはエラーメッセージ表示 |

### 5.3 エクスポートフェーズ

| 状況 | ユーザーへの通知 | システムの動作 |
|------|-----------------|--------------|
| エンコーダーが利用不可 | 「このエンコーダーはサポートされていません」 | 利用可能なエンコーダーを自動選択 |
| エンコード中のエラー | 「エクスポートに失敗しました: [詳細]」 | リトライボタン表示、ログ出力 |
| ブラウザクラッシュ | （次回起動時）「前回のエクスポートが中断されました」 | リカバリーオプション提示（オプション機能） |
| ファイルサイズが50 MBを超える | 「推定サイズが大きいです（XX MB）」 | 警告表示、設定変更を推奨 |
| エクスポート中にエンコーダー変更を試みる | 「エクスポート中は変更できません」 | UI要素を無効化 |

---

## 6. 成功基準

### 6.1 定量的指標

**パフォーマンス**:
- 初回ロード時間: < 3秒
- クリップ作成時間（300フレーム）: < 10秒
- UI応答時間: < 16ms（60 FPS）
- メモリ使用量（アイドル時）: < 500 MB
- メモリ使用量（録画中）: < 1.5 GB

**品質**:
- GIF品質（最高設定）: PSNR > 30 dB
- GIF品質（中設定）: PSNR > 25 dB
- ファイルサイズ（10秒、1080p、中品質）: < 5 MB

**信頼性**:
- クラッシュ率: < 0.1%
- エクスポート成功率: > 99%
- ブラウザ互換性: 上記4ブラウザで100%動作

### 6.2 定性的指標

**ユーザー体験**:
- 初回ユーザーがガイドなしでGIF作成可能: > 80%
- 操作が直感的と評価: > 90%
- 他ツールと比較して満足: > 85%

**機能性**:
- すべての主要機能が期待通り動作
- エッジケースが適切にハンドリングされる
- エラーメッセージが理解しやすい

---

## 7. 将来的な拡張（スコープ外）

以下は現在のスコープ外だが、将来的に検討可能:

**機能拡張**:
- MP4/WebMエクスポート
- テキスト/図形オーバーレイ
- フレーム補間（AIによる滑らか化）
- 音声録音対応
- クラウド保存

**パフォーマンス**:
- GPU加速エンコード
- マルチスレッド処理
- ストリーミングエクスポート（大容量対応）

**ユーザビリティ**:
- テンプレート機能（設定プリセット）
- ショートカットキーのカスタマイズ
- プロジェクト保存/読み込み
- バッチエクスポート

---

## 8. 用語集

| 用語 | 定義 |
|------|------|
| フレーム | 1枚の静止画像 |
| バッファ | 録画したフレームを一時的に保存する領域 |
| 循環バッファ | 古いデータを自動的に削除して新しいデータで上書きする方式 |
| クロップ | 画像の一部を切り取る操作 |
| アスペクト比 | 画像の幅と高さの比率（例: 16:9） |
| ディザリング | 色数を減らす際にノイズを加えて滑らかに見せる技法 |
| エンコード | フレームをGIFファイル形式に変換する処理 |
| WASM (WebAssembly) | ブラウザで高速に実行できるバイナリ形式のコード |
| FPS (Frames Per Second) | 1秒あたりのフレーム数。高いほど滑らか |
| PSNR (Peak Signal-to-Noise Ratio) | 画質を測る指標。高いほど高品質 |

---

**文書バージョン**: 1.0  
**最終更新**: 2025-10-31
